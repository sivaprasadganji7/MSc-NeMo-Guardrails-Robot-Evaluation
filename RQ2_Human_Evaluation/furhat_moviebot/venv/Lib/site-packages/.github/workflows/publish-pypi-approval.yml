name: Publish to PyPI (with Approval)

on:
  workflow_run:
    workflows: ["Build and Test Distribution"]
    types:
      - completed

jobs:
  publish-pypi:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment:
      name: pypi-production
      url: https://pypi.org/project/nemoguardrails/
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Detect version tag from workflow event
        id: version
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Workflow triggered by: $HEAD_BRANCH"

          if [[ "$HEAD_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            TAG_NAME="$HEAD_BRANCH"
            VERSION="${TAG_NAME#v}"

            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "artifact_name=${TAG_NAME}-build" >> $GITHUB_OUTPUT

            echo "✅ Detected version tag: $TAG_NAME"
            echo "   Version: $VERSION"
            echo "   Artifact: ${TAG_NAME}-build"
          else
            echo "❌ Not triggered by a version tag: $HEAD_BRANCH"
            echo "This workflow should only run for version tags (vX.Y.Z)"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}
          fetch-depth: 0

      - name: Validate version matches tag
        run: |
          VERSION_IN_FILE=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$VERSION_IN_FILE" != "$TAG_VERSION" ]; then
            echo "❌ Version mismatch: pyproject.toml=$VERSION_IN_FILE, tag=$TAG_VERSION"
            exit 1
          fi
          echo "✅ Version validated: $VERSION_IN_FILE matches tag $TAG_VERSION"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_name }}
          path: dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: List files
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          packages-dir: dist/
          attestations: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          CHANGELOG_SECTION=$(awk -v version="${{ steps.version.outputs.version }}" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[" version "\\]") {
                found=1
                next
              }
            }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md || echo "No changelog entry found for this version.")

          echo "$CHANGELOG_SECTION" > release_notes.md

          if gh release view "$TAG_NAME" --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "ℹ️ Release $TAG_NAME already exists, skipping creation"
          else
            if gh release create "$TAG_NAME" \
              --draft \
              --title "$TAG_NAME" \
              --notes-file release_notes.md \
              --repo ${{ github.repository }}; then
              echo "✅ Release $TAG_NAME created successfully"
            else
              echo "❌ Failed to create release $TAG_NAME" >&2
              rm -f release_notes.md
              exit 1
            fi
          fi

          rm -f release_notes.md
